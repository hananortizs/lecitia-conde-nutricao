---
alwaysApply: true
---

# Regras do Backend - LetÃ­cia Conde NutriÃ§Ã£o

## ğŸ¯ **VisÃ£o Geral**

Sistema de agendamento para nutricionista com captaÃ§Ã£o de leads via calculadora de IMC, integraÃ§Ã£o com Google Login, sistema unificado de agendamento (Site + WhatsApp) e suporte a clientes recorrentes.

## ğŸ—ï¸ **Arquitetura**

- **Framework**: ASP.NET Core 8.0
- **Banco de Dados**: PostgreSQL
- **ORM**: Entity Framework Core
- **PadrÃ£o**: Clean Architecture (API, Core, Application, Infrastructure)
- **Base Path**: `/lcn` (nÃ£o `/api` ou `/pms`) - dinÃ¢mico por ambiente (dev/hml/prd)

## ğŸ“ **Estrutura de Projetos**

```
backend/
â”œâ”€â”€ LeticiaConde.Api/           # Camada de apresentaÃ§Ã£o (Controllers, Program.cs)
â”‚   â”œâ”€â”€ Controllers/
â”‚   â”‚   â”œâ”€â”€ LeadsController.cs
â”‚   â”‚   â”œâ”€â”€ AppointmentController.cs
â”‚   â”‚   â””â”€â”€ PaymentController.cs
â”œâ”€â”€ LeticiaConde.Core/          # Entidades de domÃ­nio e interfaces
â”‚   â””â”€â”€ Entities/
â”‚       â”œâ”€â”€ Lead.cs
â”‚       â”œâ”€â”€ Appointment.cs
â”‚       â””â”€â”€ ScheduleConfiguration.cs
â”œâ”€â”€ LeticiaConde.Application/   # Casos de uso e DTOs
â”‚   â”œâ”€â”€ DTOs/
â”‚   â”‚   â”œâ”€â”€ LeadDto.cs
â”‚   â”‚   â””â”€â”€ AppointmentDto.cs
â”‚   â”œâ”€â”€ Interfaces/
â”‚   â”‚   â”œâ”€â”€ ILeadService.cs
â”‚   â”‚   â””â”€â”€ IAppointmentService.cs
â”‚   â””â”€â”€ Services/
â”‚       â”œâ”€â”€ LeadService.cs
â”‚       â””â”€â”€ AppointmentService.cs
â””â”€â”€ LeticiaConde.Infrastructure/ # Acesso a dados e configuraÃ§Ãµes externas
    â”œâ”€â”€ Data/
    â”‚   â””â”€â”€ ApplicationDbContext.cs
    â””â”€â”€ Migrations/
```

## ğŸ—„ï¸ **Entidades Principais**

### **Lead**

- Captura de leads atravÃ©s da calculadora de IMC e Google Login
- Campos: `Id`, `Name`, `Email`, `WhatsApp`, `Weight`, `Height`, `Bmi`, `BmiClassification`, `CaptureDate`, `Converted`, `GoogleId` (opcional)
- **Regra**: Email e WhatsApp Ãºnicos por lead

### **Appointment**

- Agendamentos de consultas nutricionais com origem (site/whatsapp)
- Campos: `Id`, `LeadId`, `DateTime`, `Status`, `Origin`, `ReservationDate`, `ConfirmationDate`, `VirtualRoomLink`, `Observations`, `TransactionId`
- **Status**: `Reserved` (15min), `Confirmed`, `Cancelled`, `Completed`
- **Origin**: `site` ou `whatsapp`
- **DuraÃ§Ã£o**: 30-90 minutos (flexÃ­vel, mÃ­nimo 30min)

### **ScheduleConfiguration**

- ConfiguraÃ§Ã£o de horÃ¡rios de funcionamento
- Campos: `Id`, `DayOfWeek`, `DayName`, `Active`, `StartTime`, `EndTime`, `Sabbath`, `Observations`

### **PreConsultation** (Futuro)

- Dados da anamnese completa do cliente
- Campos: InformaÃ§Ãµes bÃ¡sicas, objetivos, experiÃªncia, hÃ¡bitos alimentares
- Relacionamento: `LeadId` â†’ `Lead`

## ğŸ”§ **Regras de NegÃ³cio**

### **HorÃ¡rios de Funcionamento**

- **Segunda a Quinta**: 17:00 Ã s 22:00
- **Domingo**: HorÃ¡rio aberto (sem restriÃ§Ãµes)
- **Sexta e SÃ¡bado**: Totalmente bloqueado (Sabbat)
- **Sabbat**: Do pÃ´r do sol de sexta atÃ© pÃ´r do sol de sÃ¡bado (API externa)

### **Sistema de Reserva**

- **Reserva ProvisÃ³ria**: 15 minutos para pagamento
- **Timeout**: ApÃ³s 15min sem pagamento, status â†’ `Cancelled` e slot liberado
- **ConfirmaÃ§Ã£o**: Apenas apÃ³s webhook de pagamento confirmado
- **Sala Virtual**: Gerada automaticamente apÃ³s confirmaÃ§Ã£o (Google Meet)

### **Cliente Recorrente**

- IdentificaÃ§Ã£o via email ou WhatsApp existente
- Permite agendamento simplificado
- Permite reagendamento (atÃ© 24h antes)
- Fluxo diferenciado via WhatsApp (recomendado)

### **Reagendamento**

- Permitido atÃ© 24h antes da consulta
- LiberaÃ§Ã£o automÃ¡tica do slot anterior
- Novo slot verificado quanto Ã  disponibilidade
- HistÃ³rico mantido para auditoria

## ğŸŒ **API Endpoints**

### **ConfiguraÃ§Ã£o Global de Rotas**

O sistema utiliza convenÃ§Ãµes globais para configuraÃ§Ã£o de rotas:

1. **Prefixo Global**: Todas as rotas automaticamente recebem o prefixo `/lcn`

   - Configurado em `Program.cs` via `UseGeneralRoutePrefix("lcn")`
   - NÃ£o Ã© necessÃ¡rio especificar o prefixo em cada controller

2. **Kebab-Case AutomÃ¡tico**: Todos os nomes de controllers sÃ£o convertidos para kebab-case

   - Exemplo: `LeadsController` â†’ `leads`, `AppointmentController` â†’ `appointment`
   - Implementado via `KebabCaseControllerModelConvention`

3. **Uso de [controller]**: Controllers devem usar `[Route("[controller]")]`
   - O ASP.NET Core substitui automaticamente por `[controller]` pelo nome do controller
   - A convenÃ§Ã£o de kebab-case transforma para kebab-case automaticamente

### **Base Path**: `/lcn` (nÃ£o `/api` ou `/pms`)

**IMPORTANTE**: Todos os endpoints usam `/lcn/` como base path. O frontend deve usar `/lcn/` tambÃ©m.

### **Estrutura de Rotas**

Todas as rotas seguem o padrÃ£o: `/lcn/{controller-kebab-case}/{action-kebab-case}`

**Exemplo:**

- `LeadsController` com `[Route("[controller]")]` â†’ `/lcn/leads`
- `AppointmentController` com `[Route("[controller]")]` â†’ `/lcn/appointment`
- `PaymentController` com `[Route("[controller]")]` â†’ `/lcn/payment`

### **Leads** (`/lcn/leads`)

- âœ… `POST /lcn/leads/capture-lead` - Capturar lead com IMC
- âœ… `GET /lcn/leads/{id}` - Obter lead por ID
- âœ… `GET /lcn/leads` - Listar todos os leads
- âœ… `PUT /lcn/leads/{id}/mark-converted` - Marcar como convertido
- ğŸ”´ `GET /lcn/leads/find?email={email}&whatsapp={whatsapp}` - **PENDENTE: Verificar cliente recorrente**

### **Appointments** (`/lcn/appointment`)

- Controller: `AppointmentController` com `[Route("[controller]")]` â†’ `/lcn/appointment`
- âœ… `GET /lcn/appointment/available-slots?startDate={date}&endDate={date}` - Slots disponÃ­veis
- âœ… `POST /lcn/appointment/reserve` - Reservar horÃ¡rio (via site)
- âœ… `GET /lcn/appointment/{id}` - Obter appointment por ID
- âœ… `GET /lcn/appointment` - Listar todos os appointments
- âœ… `PUT /lcn/appointment/{id}/cancel` - Cancelar appointment
- âœ… `GET /lcn/appointment/check-availability?dateTime={datetime}` - Verificar disponibilidade
- ğŸ”´ `POST /lcn/appointment/reserve-whatsapp` - **PENDENTE: Reservar via WhatsApp**
- ğŸ”´ `PUT /lcn/appointment/{id}/reschedule` - **PENDENTE: Reagendar consulta**

### **Pre-Consultation Processes** (`/lcn/pre-consultation`)

- ğŸ”´ `POST /lcn/pre-consultation` - **PENDENTE: Salvar anamnese completa**
- Campos esperados: `LeadId`, `BasicInfo`, `Goals`, `Experience`, `Habits`

### **Payments** (`/lcn/payment`)

- âœ… `POST /lcn/payment/webhook` - Webhook de confirmaÃ§Ã£o de pagamento
- âœ… `POST /lcn/payment/confirm-appointment` - Confirmar appointment

## ğŸ”’ **ValidaÃ§Ãµes e SeguranÃ§a**

### **Data Validation**

- Input validation com Data Annotations
- ValidaÃ§Ã£o de regras de negÃ³cio nos services
- Tratamento centralizado de exceÃ§Ãµes
- ValidaÃ§Ã£o de conflitos de agendamento

### **Security**

- CORS configurado para frontend especÃ­fico
- ValidaÃ§Ã£o de entrada contra ataques
- Logs de auditoria para operaÃ§Ãµes crÃ­ticas
- ProteÃ§Ã£o contra SQL Injection (EF Core)

### **ValidaÃ§Ãµes de Agendamento**

- Verificar se estÃ¡ dentro do horÃ¡rio de funcionamento
- Verificar se nÃ£o Ã© perÃ­odo de Sabbat
- Verificar se nÃ£o hÃ¡ conflito com outros agendamentos
- Verificar se nÃ£o Ã© no passado
- Verificar disponibilidade antes de criar

## ğŸ“Š **Database Configuration**

### **PostgreSQL**

- Host: localhost (development)
- Database: `leticia_conde_nutricao`
- Username: `leticia_user`
- Password: `leticia123`

### **Migrations**

- Entity Framework Core migrations
- AplicaÃ§Ã£o automÃ¡tica em desenvolvimento
- Versionamento de schema
- Backup automÃ¡tico antes de migrations (futuro)

### **Timezone**

- Armazenamento: UTC no banco de dados
- ExibiÃ§Ã£o: America/Sao_Paulo (UTC-3)
- ConversÃµes automÃ¡ticas no Application layer

## ğŸ”„ **Fluxos de NegÃ³cio**

### **Fluxo: Cliente Novo via Site**

1. Cliente calcula IMC â†’ Lead criado
2. Cliente preenche anamnese completa
3. Sistema mostra horÃ¡rios disponÃ­veis (API unificada)
4. Cliente seleciona horÃ¡rio
5. Sistema reserva (Status: `Reserved`, 15min timeout)
6. Cliente realiza pagamento
7. Webhook confirma pagamento â†’ Status: `Confirmed`
8. Sistema gera link sala virtual (Google Meet)
9. Cliente recebe confirmaÃ§Ã£o

### **Fluxo: Cliente Recorrente via WhatsApp**

1. Cliente envia mensagem via WhatsApp
2. Sistema verifica lead existente (`GET /lcn/leads/find`)
3. Sistema verifica disponibilidade (`GET /lcn/appointment/check-availability`)
4. Sistema reserva via WhatsApp (`POST /lcn/appointment/reserve-whatsapp`)
5. Status: `Reserved` â†’ ConfirmaÃ§Ã£o manual
6. ApÃ³s confirmaÃ§Ã£o â†’ Status: `Confirmed`
7. Sistema gera link sala virtual
8. Link enviado por WhatsApp

### **Fluxo: Reagendamento**

1. Cliente solicita reagendamento (site ou WhatsApp)
2. Sistema verifica prazo (at least 24h antes)
3. Sistema verifica nova disponibilidade
4. Sistema cria novo appointment
5. Sistema cancela appointment anterior (libera slot)
6. Status anterior â†’ `Cancelled`
7. Status novo â†’ `Reserved` ou `Confirmed`
8. Cliente recebe confirmaÃ§Ã£o com novo horÃ¡rio

## ğŸš€ **Deploy and Production**

### **Base Path DinÃ¢mico** (Futuro)

- **Desenvolvimento**: `/lcn-dev/`
- **HomologaÃ§Ã£o**: `/lcn-hml/`
- **ProduÃ§Ã£o**: `/lcn-prd/`

**Nota**: Atualmente usando `/lcn` fixo para todos os ambientes.

### **Configurations**

- VariÃ¡veis de ambiente para configuraÃ§Ãµes sensÃ­veis
- Logs estruturados para monitoramento
- Health checks para verificaÃ§Ã£o de saÃºde
- Docker Compose para containerizaÃ§Ã£o (opcional)

## ğŸ“ **Naming Conventions**

### **API Routes**

- âœ… **Prefixo Global**: `/lcn` Ã© aplicado automaticamente (nÃ£o precisa especificar)
- âœ… **Kebab-Case AutomÃ¡tico**: Nomes de controllers convertidos automaticamente
- âœ… **Use [controller]**: Sempre usar `[Route("[controller]")]` nos controllers
- Formato final: `/lcn/{controller-kebab-case}/{action-kebab-case}`
- Exemplos:
  - `LeadsController` com `[Route("[controller]")]` â†’ `/lcn/leads`
  - AÃ§Ã£o `[HttpPost("capture-lead")]` â†’ `/lcn/leads/capture-lead`
  - `AppointmentController` com `[Route("[controller]")]` â†’ `/lcn/appointment`
  - AÃ§Ã£o `[HttpGet("available-slots")]` â†’ `/lcn/appointment/available-slots`

### **ConfiguraÃ§Ã£o em Controllers**

```csharp
[ApiController]
[Route("[controller]")]  // âœ… Sempre usar [controller], nÃ£o o nome completo
public class LeadsController : ControllerBase
{
    [HttpPost("capture-lead")]  // âœ… Actions em kebab-case
    public async Task<ActionResult> CaptureLead(...) { }
}
```

**Resultado**: `/lcn/leads/capture-lead`

### **Code Elements**

- **Classes**: PascalCase (e.g., `LeadService`, `AppointmentController`)
- **Methods**: PascalCase (e.g., `CalculateBmiAsync`, `GetAvailableSlotsAsync`)
- **Properties**: PascalCase (e.g., `Name`, `Email`, `DateTime`)
- **Variables**: camelCase (e.g., `leadId`, `appointmentDate`)
- **Constants**: UPPER_SNAKE_CASE (e.g., `MAX_WEIGHT`, `DEFAULT_TIMEOUT`)

### **Database**

- **Tables**: PascalCase (e.g., `Leads`, `Appointments`, `ScheduleConfigurations`)
- **Columns**: PascalCase (e.g., `Id`, `Name`, `Email`, `DateTime`)
- **Foreign Keys**: `EntityNameId` (e.g., `LeadId`, `AppointmentId`)

## ğŸ”§ **Development Guidelines**

### **ConfiguraÃ§Ã£o Global de Rotas**

O sistema estÃ¡ configurado com convenÃ§Ãµes globais em `Program.cs`:

```csharp
builder.Services.AddControllers(options =>
{
    // ConvenÃ§Ã£o para kebab-case automÃ¡tico
    options.Conventions.Add(new KebabCaseControllerModelConvention());

    // Prefixo global "lcn" para todas as rotas
    options.UseGeneralRoutePrefix("lcn");
});
```

**Arquivos de ConvenÃ§Ã£o:**

- `Conventions/KebabCaseControllerModelConvention.cs` - Converte nomes de controllers para kebab-case
- `Extensions/RoutePrefixConventionExtension.cs` - Aplica prefixo global Ã s rotas

**Como Usar:**

1. âœ… **Sempre use `[Route("[controller]")]`** nos controllers (nÃ£o especifique o nome completo)
2. âœ… **Actions devem usar kebab-case** nos atributos HTTP (ex: `[HttpPost("capture-lead")]`)
3. âœ… **O prefixo `/lcn` Ã© aplicado automaticamente** (nÃ£o precisa especificar)

**Exemplo Correto:**

```csharp
[ApiController]
[Route("[controller]")]  // âœ… Correto - usa [controller]
public class LeadsController : ControllerBase
{
    [HttpPost("capture-lead")]  // âœ… Kebab-case
    public async Task<ActionResult> CaptureLead(...) { }
}
```

**Resultado**: A rota final serÃ¡ `/lcn/leads/capture-lead`

### **Error Handling**

- Use tipos de exceÃ§Ã£o especÃ­ficos
- ForneÃ§a mensagens de erro significativas
- Registre erros com contexto
- Retorne cÃ³digos de status HTTP apropriados
- Use padrÃ£o `ApiResponse<T>` para respostas consistentes

### **Logging**

- Use logging estruturado
- Inclua correlation IDs
- Registre nos nÃ­veis apropriados (Debug, Info, Warning, Error)
- Inclua contexto relevante nas mensagens
- Logs de auditoria para operaÃ§Ãµes crÃ­ticas

### **API Response Format**

```csharp
{
  "success": true,
  "data": { ... },
  "error": null,
  "message": "OperaÃ§Ã£o realizada com sucesso"
}
```

### **Testing**

- Escreva testes unitÃ¡rios para lÃ³gica de negÃ³cio
- Escreva testes de integraÃ§Ã£o para endpoints da API
- Mock dependÃªncias externas
- Teste cenÃ¡rios de erro e casos extremos
- Teste regras de negÃ³cio (horÃ¡rios, Sabbat, conflitos)

## ğŸ¯ **PendÃªncias CrÃ­ticas**

### **Endpoints Pendentes**

1. `GET /lcn/leads/find` - Verificar cliente recorrente
2. `POST /lcn/pre-consultation` - Salvar anamnese completa
3. `POST /lcn/appointment/reserve-whatsapp` - Reservar via WhatsApp
4. `PUT /lcn/appointment/{id}/reschedule` - Reagendar consulta

### **Funcionalidades Pendentes**

1. GeraÃ§Ã£o automÃ¡tica de link Google Meet
2. Timeout automÃ¡tico de 15 minutos para pagamento
3. Sistema de notificaÃ§Ãµes (email/SMS)
4. Dashboard admin (futuro)
5. IntegraÃ§Ã£o WhatsApp Bot (futuro)

## ğŸ“š **ReferÃªncias**

- Regras de NegÃ³cio: `docs/03-business-rules/regras-negocio.md`
- Arquitetura de Agendamento: `docs/02-architecture/agendamento-unificado.md`
- IntegraÃ§Ã£o WhatsApp: `backend/WHATSAPP_INTEGRATION.md`
